{%- extends "base.html" -%}
{% block title %}Game {{ game_id }}{% endblock %}

{% block head %}
  <script src="{{ url_for('static', filename='js/h.js') }}"></script>
  {{ super() }}
  <script>
    var game_id = {{ game_id }};
    var player_id = {{ player_id }};
    var currentState;
    var endpoint = '';

    var handlers = {};
    var httpHost = "{{ server_full }}";

    function resetDisplay() {
      while (disp.firstChild) {
        disp.removeChild(disp.firstChild);
      }
    };

    function mainHandler(data) {
      renderOverview(data['overview']);
      if (currentState != data['state']) {
        var action = data.action;
        var handler = handlers[action];

        resetDisplay();
        if (handler !== undefined) {
          handler(data);
          currentState = data['state'];
        } else {
          console.log("No handler found for action " + action, data, handlers);
        }
      }
    };
  </script>
{% endblock %}

{% block footer -%}
  <script src="{{ url_for('static', filename='js/overview.js') }}"></script>
  <script>
    var disp = document.querySelector('#game-display');

    var ws = new WebSocket("{{ config['WS_PROTOCOL'] }}://{{ server_name }}:{{ config['EXTERNAL_WS_PORT'] }}/" + endpoint + "/" + game_id + "/" + player_id);

    ws.onmessage = function (event) {
      var data = JSON.parse(event.data);
      mainHandler(data);
    };

    handlers.view = function(data) {
      var pageData;
      for (const stack of data.stacks) {
        disp.appendChild(h('h2', {}, stack.owner + "'s stack:"));
        for (const page of stack.pages) {
          pageData = page.content;
          if (page.type == 'Drawing') {
            disp.appendChild(h('p', {}, page.author + ' drew:'));
            disp.appendChild(h('img', {class: 'img-fluid img-thumbnail mb-3', src: pageData}));
          } else if (page.type == 'Writing') {
            disp.appendChild(h('p', {}, page.author + ' wrote:'));
            disp.appendChild(h('p', {class: 'card card-body'}, pageData));
          } else {
            // Player passed due to leaving
            disp.appendChild(h('p', {}, page.author + ' was not in the game'));
          }
        }
      }
    };

  </script>
{%- endblock %}
